# If our project had something to compile, it would be C probably
language: c

# Use sudo-less Ubuntu Trusty 14.04.5 LTS
dist: trusty
sudo: required

## Configure, compile and test the project using the four different build types

matrix:
  fast_finish: true

env:
  - CMAKE_BUILD_TYPE=Debug
  - CMAKE_BUILD_TYPE=Release
  - CMAKE_BUILD_TYPE=RelWithDebInfo
  - CMAKE_BUILD_TYPE=MinSizeRel

# Install the dependencies
install:
  - sudo apt-get update
  - sudo apt-get install -y cmake lrzip
  - curl -s https://cmake.org/files/v3.13/cmake-3.13.0-rc2-Linux-x86_64.sh > cmake-3.13.0-rc2-Linux-x86_64.sh
  - sudo mkdir -p /usr/local/cmake-3.13.0-rc2
  - sudo bash cmake-3.13.0-rc2-Linux-x86_64.sh --skip-license --exclude-subdir --prefix=/usr/local/cmake-3.13.0-rc2
  - export PATH="/usr/local/cmake-3.13.0-rc2/bin:$PATH"

# Configure the project
before_script:
  - mkdir build
  - cd build
  - cmake -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} ..

# Build and install the project
script:
  - cmake --build .
  - sudo cmake --build . --target install

# Create the packages before deploying
before_deploy:
  - sudo cpack --config CPackConfig.cmake
  - sudo cpack --config CPackSourceConfig.cmake
  - export PROJECT_VERSION=$(grep VERSION "${TRAVIS_BUILD_DIR}/CMakeLists.txt" | awk 'NR==2 {print gensub(/^.*VERSION +([0-9]+(\.[0-9]+){,3}).*$/, "\\1", "g", $0)}')
  - export PROJECT_NAME=$(echo $TRAVIS_REPO_SLUG | cut -d'/' -f 2-)

# Deploy to GitHub Releases
deploy:
  - provider: releases
    api_key:
      secure: DPcRUtAQmwTPPZo0aZVWkVH+AbKEPv2YKqrz2aFNPKot38xWqyrMZ+Sp4F5G248p3zRX2RlLi9BPgMlhQp3WlI8k755N7XhmpUtt0uYn+4Jmi/vwYjJjyZZtTIkyJdSZEOlMECJVk4wA/V3uzA4bzEzh5ZDDXcuWoY791WHUVzL+b2vQOSIMVCxVJnjUNEOKZwAdUozy+XjIfOncJcdT8CYYV9NNubKNboXtl/Qzt9h0B66xUD1qELkCwgxD/tjGVWrNXSERk7h464sgDvYKSXto6oGnKVqWKT6FN0DFCDwJR8EyZQB+5eSy9xx6YYgdaEK3SYPdtDgxH71QttIkRDBtD9JQeXGood16wLGLrBq7mIlhuW20THfWYvjOpSzSqtXobaANjAbxm+GovFZ5lPUMeMf6hV7comhTDMBGhlM91XY9uAlJiJBZKNKm0K7/Ip9J3GdUOvCYmiM2G34iqW2jNubFr9FYTcUYSBMClUjBTrjxkAzBofjp08Uqb0FRRCO2EpYfDsX+1cDBgpTD6c3uCHr5l5q0hZy9BW/o03rQ+YbzidhyBz447Sdf7n4u5toeUcxE6SkLxWLATyfO71/SzCJgXis3w5zcPYSzsZnJ4rthNBHPDSvDoRV6s4ItOS61YGqe2eS7gHxYhDANTfSX1prsGibZdQyEG6Thwtw=
    file:
      - build/$PROJECT_NAME-$PROJECT_VERSION-Linux.tar.bz2
      - build/$PROJECT_NAME-$PROJECT_VERSION-Linux.tar.gz
      - build/$PROJECT_NAME-$PROJECT_VERSION-Linux.tar.Z
      - build/$PROJECT_NAME-$PROJECT_VERSION-Linux.zip
      - build/$PROJECT_NAME-$PROJECT_VERSION-Linux.sh
      - build/$PROJECT_NAME.tar.bz2
      - build/$PROJECT_NAME.tar.gz
      - build/$PROJECT_NAME.tar.Z
      - build/$PROJECT_NAME.zip
      - build/$PROJECT_NAME.sh
    skip_cleanup: true
    overwrite: true
    name: "Release $TRAVIS_TAG"
    body: "Automatic release made by Travis CI"
    draft: true
    prerelease: false
    on:
      branch: develop
#      tags: true
